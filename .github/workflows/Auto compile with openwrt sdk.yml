name: "Auto compile with openwrt sdk (Manual Platform Select)"
on:
  workflow_dispatch:
    inputs:
      platform:
        description: '选择平台'
        required: true
        default: 'x86_64'
        type: choice
        options:
          - x86_64
          - aarch64_generic
          - aarch64_cortex-a53
          - aarch64_cortex-a72
          - arm_cortex-a5_vfpv4
          - arm_cortex-a7
          - arm_cortex-a7_neon-vfpv4
          - arm_cortex-a8_vfpv3
          - arm_cortex-a9
          - arm_cortex-a9_neon
          - arm_cortex-a9_vfpv3-d16
          - arm_cortex-a15_neon-vfpv4
          - mips_24kc
          - mips_4kec
          - mips_mips32
          - mipsel_24kc
          - mipsel_74kc
          - mipsel_mips32
      sdk_type:
        description: '选择sdk类型'
        required: true
        default: 'stable'
        type: choice
        options:
          - stable
          - snapshot
      compile_packages:
        description: '是否编译依赖包'
        required: false
        default: 'true'
        type: boolean
      ssh:
        description: '是否开启ssh调试'
        required: false
        default: 'false'
        type: boolean

env:
  TZ: Asia/Shanghai
  passwall: ${{ github.repository }}
  packages: xiaorouji/openwrt-passwall-packages
  package_names: "chinadns-ng dns2socks geoview hysteria ipt2socks microsocks naiveproxy tcping trojan-plus tuic-client shadowsocks-rust shadowsocksr-libev simple-obfs sing-box v2ray-geodata v2ray-plugin xray-core xray-plugin shadow-tls"
  package_release: "chinadns-ng dns2socks geoview hysteria ipt2socks microsocks naiveproxy tcping trojan-plus tuic-client shadowsocks-rust shadowsocksr-libev simple-obfs sing-box v2ray-geoip v2ray-plugin v2ray-geosite xray-core xray-plugin shadow-tls"

jobs:
  job_build_manual:
    name: Build for ${{ inputs.platform }} (${{ inputs.sdk_type }})
    runs-on: ubuntu-latest
    steps:
      # 其他步骤...

      # 组织输出文件
      - name: Organize output files
        run: |
          cd sdk
          mkdir -p output
          # 复制 luci-app-passwall 包
          for luci_pkg in bin/packages/*/passwall/luci-app-passwall*; do
              if [ -f "$luci_pkg" ]; then
                  cp "$luci_pkg" output/
              fi
          done
          
          # 复制依赖包
          if [ "${{ inputs.compile_packages }}" == "true" ]; then
              mkdir -p output/packages
              shopt -s nullglob
              for src_dir in bin/packages/*/{packages,passwall_packages}; do
                  [[ -d "$src_dir" ]] || continue
                  for prefix in ${{ env.package_release }}; do
                      for file in "$src_dir"/"$prefix"*; do
                          [[ -f "$file" ]] || continue
                          cp "$file" output/packages/
                      done
                  done
              done
          fi
          
          # 创建信息文件
          echo "# Build Information" > output/build-info.txt
          echo "Platform: ${{ inputs.platform }}" >> output/build-info.txt
          echo "SDK Type: ${{ inputs.sdk_type }}" >> output/build-info.txt
          echo "Version: ${{ steps.get_version.outputs.version }}" >> output/build-info.txt
          echo "Build Date: $(date)" >> output/build-info.txt
          
          # 创建 ZIP 压缩包
          cd output
          if [ "${{ inputs.compile_packages }}" == "true" ]; then
              zip -r ../passwall_${{ inputs.platform }}_${{ inputs.sdk_type }}_full.zip ./*
          else
              zip -r ../passwall_${{ inputs.platform }}_${{ inputs.sdk_type }}_luci_only.zip ./*
          fi
          
          echo "FIRMWARE=$(pwd)/.." >> $GITHUB_ENV

      # 生成发布标签
      - name: Generate Release tag
        id: tag
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true'
        run: |
          # 生成基于日期的 Release 标签
          echo "release_tag=$(date +"%Y.%m.%d-%H%M%S")" >> $GITHUB_OUTPUT
          touch release.txt
          echo "status=success" >> $GITHUB_OUTPUT

      # 生成发布内容
      - name: Generate Release content
        run: |
          # 创建发布内容并添加下载统计徽章
          echo "![](https://img.shields.io/github/downloads/${{ github.repository }}/${{ steps.tag.outputs.release_tag }}/total?style=flat-square)" >> release.txt
          
      # 上传固件到 Release
      - name: Upload firmware to GitHub Releases
        uses: softprops/action-gh-release@v1
        if: steps.tag.outputs.status == 'success'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          name: ${{ env.OPNAME }}
          tag_name: ${{ steps.tag.outputs.release_tag }}
          body_path: release.txt
          files: ${{ env.FIRMWARE }}/*

      # 生成汇总
      - name: Generate summary
        if: always()
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "**Platform**: ${{ inputs.platform }}" >> $GITHUB_STEP_SUMMARY
          echo "**SDK Type**: ${{ inputs.sdk_type }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ steps.get_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Packages Compiled**: ${{ inputs.compile_packages }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Artifacts have been uploaded and can be downloaded from the workflow run page." >> $GITHUB_STEP_SUMMARY
